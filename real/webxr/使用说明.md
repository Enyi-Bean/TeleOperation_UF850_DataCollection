# UF850 机械臂 WebXR 遥操作 - 使用说明

## 正确的启动顺序

### 终端 1：启动机械臂控制程序
```bash
cd ~/Code/UF850/teleVR/real/webxr
python3 xarm_webxr_control_final.py
```

**等待显示：**
```
WebSocket 服务器启动中...
监听端口: 8765
等待标定...
```

### 终端 2：启动 USB 端口转发和 HTTP 服务器
```bash
cd ~/Code/UF850/teleVR/real/webxr
./start_usb.sh
```

**应该看到：**
```
✓ WebSocket 服务器已在运行（端口 8765）
✓ USB 模式已启动!
在 Quest 3 浏览器中访问:
   http://localhost:8080/controller_usb.html
```

### Quest 3 操作
1. 在 Quest 3 浏览器中访问：`http://localhost:8080/controller_usb.html`
2. 点击 **"开始 VR 模式"** 按钮
3. 进入 VR 后，将右手柄移动到舒适位置
4. **按住右手柄 Trigger 键** 进行标定
5. 标定完成后，移动手柄即可控制机械臂

---

## 常见问题

### 问题 1：终端 2 显示 "未检测到 WebSocket 服务器"

**原因：** 终端 1 还没有启动或启动失败

**解决：**
1. 确保终端 1 先启动
2. 检查终端 1 是否显示 "监听端口: 8765"
3. 如果有错误，先解决终端 1 的问题

### 问题 2：Quest 3 连接失败或显示 "undefined"

**原因：** WebSocket 服务器未运行或端口转发失败

**解决：**
```bash
# 检查 WebSocket 服务器
lsof -i:8765

# 检查端口转发
adb reverse --list

# 应该看到：
# 8765 tcp:8765
# 8080 tcp:8080
```

### 问题 3：按了 Trigger 但机械臂不动

**检查清单：**
1. 终端 1 是否显示 "✓ 标定完成！"？
2. 终端 1 是否有 "Quest 3 已连接" 消息？
3. 移动手柄时终端 1 是否有数据输出？

**如果终端 1 没有任何数据：**
- Quest 3 的数据可能被其他程序接收了
- 检查是否有多个 WebSocket 服务器在运行：
  ```bash
  ps aux | grep -E "server.py|xarm_webxr"
  ```

### 问题 4：机械臂移动太快或太慢

**调整配置文件：** `/home/enyi/Code/UF850/teleVR/real/config.py`

```python
# 控制移动幅度（越大越慢）
SCALE_FACTOR = 10  # 建议范围 5-20

# 控制速度
TRAJECTORY_SPEED = 300  # mm/s，建议范围 200-500
MAX_DELTA_POSITION = 8.0  # mm，单步最大移动

# 控制平滑度
POSITION_SMOOTHING = 0.5  # 0-1，越大越平滑但延迟越高
```

---

## 文件说明

| 文件 | 用途 | 状态 |
|------|------|------|
| `xarm_webxr_control_final.py` | ✅ 主控制程序（使用此版本） | 推荐 |
| `start_usb.sh` | ✅ USB 端口转发脚本（已修改，不启动 server.py） | 推荐 |
| `controller_usb.html` | ✅ WebXR 网页 | 推荐 |
| `config.py` | ✅ 配置文件 | 可调整参数 |
| `xarm_webxr_control.py` | 旧版本（坐标映射有问题） | 不推荐 |
| `xarm_webxr_control_fixed.py` | 旧版本（连接有问题） | 不推荐 |
| `server.py` | 简单测试服务器（不控制机械臂） | 仅测试用 |

---

## 调试版本

如果遇到问题，可以使用调试版本查看详细信息：

**终端 1：**
```bash
python3 xarm_webxr_control_debug.py
```

调试版本会显示：
- VR 原始数据（每50帧）
- 计算的目标位姿
- 发送到机械臂的指令
- 详细的错误信息

---

## 停止服务

1. **终端 2**：按 `Ctrl+C` 停止 HTTP 服务器和端口转发
2. **终端 1**：按 `Ctrl+C` 停止机械臂控制程序

机械臂会自动暂停到安全状态。

---

## 架构说明

```
Quest 3 (VR头显)
    ↓ USB 线
    ↓ adb reverse (端口转发)
    ↓
Ubuntu 电脑
    ├─ 终端 1: xarm_webxr_control_final.py (WebSocket 8765 + 机械臂控制)
    └─ 终端 2: start_usb.sh (HTTP 8080)
         ↓
UF850 机械臂 (192.168.1.117)
```

**数据流：**
1. Quest 3 访问 `localhost:8080` → HTTP 服务器（终端2）
2. WebXR 网页连接 `localhost:8765` → WebSocket 服务器（终端1）
3. 手柄数据 → 坐标转换 → 机械臂指令 → UF850

---

## 坐标系说明

### 面对面模式（默认）
- 您站在机械臂对面
- 您的右手 → 机械臂向左移动（镜像）
- 您的手向上 → 机械臂向上
- 您的手向前推 → 机械臂向前（朝向您）

### 同向模式
修改 `xarm_webxr_control_final.py` 第 24 行：
```python
face_to_face = False  # 改为 False
```

---

## 技术支持

如果遇到问题：
1. 先查看上面的常见问题
2. 使用调试版本查看详细日志
3. 检查机械臂连接和状态
4. 确认 Quest 3 USB 调试权限